################################################################################
# 1. Runs checks and install on "main".
# 2. Creates a PR containing the "./docs" output
# 3. Skips building that same PR again when pushed back to "main".
################################################################################
name: main_push

# place "magic strings" used in the workflow here for convenient maintenance
env:
  # this variable is used to compare against forked repositories
  OUR_REPO: "ourchitecture/ourchitecture.github.com"
  OUR_AUTODOC_COMMIT: "docs: auto-generated documentation"
  OUR_AUTODOC_DESC: "Automatically generated documentation that requires a PR, because the main branch is protected."
  OUR_AUTODOC_LABELS: "documentation"
  # this variable uses a system account since there are permission issues when assigning teams
  # see: https://github.com/peter-evans/create-pull-request/issues/155#issuecomment-611904487
  OUR_AUTODOC_REVIEWERS: "ourchitectureio"
  OUR_AUTODOC_ASSIGNEES: "ourchitectureio"
  OUR_SKIP_CI: "[skip ci]"

on:
  push:
    branches: ["main"]

jobs:
  integration:
    # run build if not a create PR patch
    if: ${{ github.repository == env.OUR_REPO && !contains(github.event.head_commit.message, 'ourchitecture/create-pull-request/patch') }}

    env:
      CI: true

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          # See: https://github.com/actions/setup-node/blob/main/docs/advanced-usage.md#caching-packages-data
          cache: "yarn"
          cache-dependency-path: "./**/yarn.lock"

      - name: install
        run: |
          make install
          sudo chown -R $(whoami) ./docs

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        if: ${{ github.event_name == 'push' && github.repository == env.OUR_REPO }}
        with:
          title: ${{ env.OUR_AUTODOC_COMMIT }}
          signoff: true
          commit-message: "${{ env.OUR_AUTODOC_COMMIT }} ${{ env.OUR_SKIP_CI }}"
          body: ${{ env.OUR_AUTODOC_DESC }}
          labels: ${{ env.OUR_AUTODOC_LABELS }}
          assignees: ${{ env.OUR_AUTODOC_ASSIGNEES }}
          # a PAT was generated to support this field
          # see: https://github.com/peter-evans/create-pull-request/issues/155
          team-reviewers: ${{ env.OUR_AUTODOC_REVIEWERS }}
