# This is a basic workflow to help you get started with Actions
name: DevOps

# place "magic strings" used in the workflow here for convenient maintenance
env:
  # this variable is used to compare against forked repositories
  OUR_REPO: "ourchitecture/ourchitecture.github.com"
  OUR_AUTODOC_COMMIT: "docs: auto-generated documentation"
  OUR_AUTODOC_DESC: "Automatically generated documentation that requires a PR, because the main branch is protected."
  OUR_AUTODOC_LABELS: "documentation"
  # this variable uses a system account since there are permission issues when assigning teams
  # see: https://github.com/peter-evans/create-pull-request/issues/155#issuecomment-611904487
  OUR_AUTODOC_REVIEWERS: "ourchitectureio"
  OUR_AUTODOC_ASSIGNEES: "ourchitectureio"
  OUR_SKIP_CI: "[skip ci]"

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ 'main' ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

    integration:

        env:
            CI: true

        # The type of runner that the job will run on
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [18.x]

        # Steps represent a sequence of tasks that will be executed as part of the job
        steps:
            # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
            - uses: actions/checkout@v3

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v3
              with:
                node-version: ${{ matrix.node-version }}
                # See: https://github.com/actions/setup-node/blob/main/docs/advanced-usage.md#caching-packages-data
                cache: 'yarn'
                cache-dependency-path: './**/yarn.lock'

            - name: install
              run: |
                make install
                sudo chown -R $(whoami) ./docs

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v4
              if: ${{ github.event_name == 'push' && github.repository == env.OUR_REPO }}
              with:
                title: ${{ env.OUR_AUTODOC_COMMIT }}
                signoff: true
                commit-message: "${{ env.OUR_AUTODOC_COMMIT }} ${{ env.OUR_SKIP_CI }}"
                body: ${{ env.OUR_AUTODOC_DESC }}
                labels: ${{ env.OUR_AUTODOC_LABELS }}
                assignees: ${{ env.OUR_AUTODOC_ASSIGNEES }}
                # a PAT was generated to support this field
                # see: https://github.com/peter-evans/create-pull-request/issues/155
                team-reviewers: ${{ env.OUR_AUTODOC_REVIEWERS }}
